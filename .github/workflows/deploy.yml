name: Deploy Brand Kit

on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build & Deploy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get install -y zsh
          npm install -g wrangler

      - name: Write brand.json
        run: |
          python3 -c "
          import json
          brand = {
            'name': 'BlackRoad OS',
            'tagline': 'Your AI. Your Hardware. Your Rules.',
            'description': 'The AI-native developer platform.',
            'cta_text': 'Get Started',
            'cta_url': '/blackroad-brand-kit/docs/',
            'footer': '¬© 2026 BlackRoad OS, Inc.',
            'og_url': 'https://blackroad-os-inc.github.io/blackroad-brand-kit/',
            'twitter': '@blackroadOS',
            'nav': [
              {'label': 'Docs',    'url': '/blackroad-brand-kit/docs/'},
              {'label': 'Pricing', 'url': '/blackroad-brand-kit/pricing/'},
              {'label': 'Agents',  'url': '/blackroad-brand-kit/agents.html'},
              {'label': 'About',   'url': '/blackroad-brand-kit/about/'}
            ]
          }
          with open('brand.json', 'w') as f:
            json.dump(brand, f, indent=2)
          print('brand.json written')
          "

      - name: Build site
        run: |
          chmod +x br-brand.sh
          # Core 7 pages (hero, pricing, 2 checkout, docs, about, 404)
          zsh br-brand.sh site --config brand.json --out ./site
          # Extra pages
          zsh br-brand.sh new feature \
            --config brand.json \
            --title "AI Agent System" \
            --subtitle "30,000 concurrent agents. Modular. Autonomous. Yours." \
            --item "ü§ñ|Agent Mesh|Deploy up to 30,000 agents across cloud, edge, and hardware." \
            --item "üß†|CECE Identity|Portable AI identity that persists across models and providers." \
            --item "‚ö°|Tokenless Gateway|Agents never embed API keys. Trust boundary at the gateway." \
            --item "üíæ|PS-SHA‚àû Memory|Hash-chained journals ‚Äî every action verifiable and tamper-evident." \
            --output ./site/agents.html
          zsh br-brand.sh new team \
            --title "The Team" \
            --subtitle "The builders behind BlackRoad OS." \
            --config brand.json \
            --output ./site/team/index.html
          zsh br-brand.sh new changelog \
            --title "Changelog" \
            --subtitle "What's new in BlackRoad OS." \
            --config brand.json \
            --output ./site/changelog/index.html
          # Success / cancel pages for Stripe checkout flow
          python3 - << 'PYEOF'
          success = open('templates/success.html').read() if __import__('os').path.exists('templates/success.html') else None
          PYEOF
          # Copy static success/cancel if they exist, otherwise generate inline
          if [ -f templates/success.html ]; then
            cp templates/success.html site/success.html
          else
            cat > site/success.html << 'HTMLEOF'
          <!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Payment Successful ‚Äî BlackRoad OS</title>
          <meta http-equiv="refresh" content="3;url=/blackroad-brand-kit/docs/"></head>
          <body style="background:#000;color:#fff;font-family:system-ui;display:flex;align-items:center;justify-content:center;min-height:100vh;text-align:center;">
          <div><div style="font-size:4rem;margin-bottom:1rem">‚úÖ</div>
          <h1 style="background:linear-gradient(135deg,#F5A623,#FF1D6C,#9C27B0,#2979FF);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-size:2rem;font-weight:900;">Payment Successful!</h1>
          <p style="color:rgba(255,255,255,.7);margin-top:1rem;">Redirecting to docs in 3 seconds‚Ä¶</p>
          <a href="/blackroad-brand-kit/docs/" style="display:inline-block;margin-top:2rem;padding:12px 28px;background:linear-gradient(135deg,#F5A623,#FF1D6C);color:#fff;text-decoration:none;border-radius:10px;font-weight:700;">Go to Docs ‚Üí</a></div>
          </body></html>
          HTMLEOF
          fi
          if [ -f templates/cancel.html ]; then
            cp templates/cancel.html site/cancel.html
          else
            cat > site/cancel.html << 'HTMLEOF'
          <!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Checkout Cancelled ‚Äî BlackRoad OS</title></head>
          <body style="background:#000;color:#fff;font-family:system-ui;display:flex;align-items:center;justify-content:center;min-height:100vh;text-align:center;">
          <div><div style="font-size:4rem;margin-bottom:1rem">‚Ü©Ô∏è</div>
          <h1 style="color:#fff;font-size:2rem;font-weight:900;margin-bottom:1rem;">No worries ‚Äî nothing was charged.</h1>
          <p style="color:rgba(255,255,255,.65)">Come back whenever you're ready.</p>
          <a href="/blackroad-brand-kit/pricing/pro/" style="display:inline-block;margin-top:2rem;padding:12px 28px;background:linear-gradient(135deg,#F5A623,#FF1D6C);color:#fff;text-decoration:none;border-radius:10px;font-weight:700;">Try Again ‚Üí</a></div>
          </body></html>
          HTMLEOF
          fi
          echo "--- Site structure ---"
          find site -name "*.html" | sort

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages
          force_orphan: true

      - name: Deploy to Cloudflare Pages
        continue-on-error: true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: "848cf0b18d51e0170e0d1537aec3505a"
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "CLOUDFLARE_API_TOKEN not set ‚Äî skipping CF Pages deploy"
            exit 0
          fi
          wrangler pages deploy site --project-name=blackroad-brand-kit --branch=main --commit-dirty=true

      - name: Deploy Stripe Worker
        continue-on-error: true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: "848cf0b18d51e0170e0d1537aec3505a"
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
        working-directory: workers/stripe
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "CLOUDFLARE_API_TOKEN not set ‚Äî skipping Stripe worker deploy"
            exit 0
          fi
          if [ -n "$STRIPE_SECRET_KEY" ]; then
            echo "$STRIPE_SECRET_KEY" | wrangler secret put STRIPE_SECRET_KEY
          fi
          if [ -n "$STRIPE_WEBHOOK_SECRET" ]; then
            echo "$STRIPE_WEBHOOK_SECRET" | wrangler secret put STRIPE_WEBHOOK_SECRET
          fi
          wrangler deploy

      - name: Register Custom Domains
        continue-on-error: true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: "848cf0b18d51e0170e0d1537aec3505a"
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "CLOUDFLARE_API_TOKEN not set ‚Äî skipping domain registration"
            exit 0
          fi

          ACCOUNT_ID="848cf0b18d51e0170e0d1537aec3505a"

          echo "=== Registering brand.blackroad.io on CF Pages ==="
          curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/pages/projects/blackroad-brand-kit/domains" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name":"brand.blackroad.io"}' | python3 -c "
          import json,sys
          d=json.load(sys.stdin)
          if d.get('success'):
              print('‚úÖ brand.blackroad.io registered:', d.get('result',{}).get('name'))
          else:
              errs = d.get('errors',[])
              # 8000000 = already exists
              if any(e.get('code') in [8000000, 1000015] for e in errs):
                  print('‚úÖ brand.blackroad.io already registered')
              else:
                  print('‚ö†Ô∏è brand.blackroad.io:', errs)
          "

          echo "=== Registering stripe.blackroad.io custom domain on Worker ==="
          curl -s -X PUT \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/workers/domains" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "environment": "production",
              "hostname": "stripe.blackroad.io",
              "service": "blackroad-stripe",
              "zone_id": "d6566eba4500b460ffec6650d3b4baf6"
            }' | python3 -c "
          import json,sys
          d=json.load(sys.stdin)
          if d.get('success'):
              print('‚úÖ stripe.blackroad.io registered:', d.get('result',{}).get('hostname'))
          else:
              print('‚ö†Ô∏è stripe.blackroad.io:', d.get('errors',[]))
          "
