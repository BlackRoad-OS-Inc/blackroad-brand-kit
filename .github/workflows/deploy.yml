name: Deploy Brand Kit

on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build & Deploy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get install -y zsh
          npm install -g wrangler

      - name: Write brand.json
        run: |
          python3 -c "
          import json
          brand = {
            'name': 'BlackRoad OS',
            'tagline': 'Your AI. Your Hardware. Your Rules.',
            'description': 'The AI-native developer platform.',
            'cta_text': 'Get Started',
            'cta_url': '/docs',
            'footer': 'Â© 2026 BlackRoad OS, Inc.',
            'nav': [
              {'label': 'Docs', 'url': '/docs'},
              {'label': 'Pricing', 'url': '/pricing'},
              {'label': 'Agents', 'url': '/agents'},
              {'label': 'Team', 'url': '/team'}
            ]
          }
          with open('brand.json', 'w') as f:
            json.dump(brand, f, indent=2)
          print('brand.json written')
          "

      - name: Build site
        run: |
          chmod +x tools/br-brand.sh
          zsh tools/br-brand.sh site --config brand.json --out ./site
          zsh tools/br-brand.sh new team --title "The Team" --subtitle "The agents behind BlackRoad OS." --config brand.json --output ./site/team/index.html
          zsh tools/br-brand.sh new changelog --title "Changelog" --subtitle "Whats new in BlackRoad OS." --config brand.json --output ./site/changelog/index.html
          zsh tools/br-brand.sh new checkout --title "BlackRoad Pro" --price '$49/mo' --price-id "price_1T3nxYChUUSEbzyhRA8XeENr" --worker "https://blackroad-stripe.848cf0b18d51e0170e0d1537aec3505a.workers.dev" --feature "All 16 brand templates" --feature "br brand deploy to Cloudflare Pages" --feature "Stripe checkout and billing portal" --feature "GitHub Actions auto-deploy" --feature "Priority support" --cta "Start Free Trial" --output ./site/checkout/index.html
          ls -la site/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages
          force_orphan: true

      - name: Deploy to Cloudflare Pages
        if: ${{ secrets.CLOUDFLARE_API_TOKEN != '' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: "848cf0b18d51e0170e0d1537aec3505a"
        run: |
          wrangler pages deploy site \
            --project-name=blackroad-brand-kit \
            --branch=main \
            --commit-dirty=true

  deploy-stripe-worker:
    runs-on: ubuntu-latest
    name: Deploy Stripe Worker
    needs: build-and-deploy
    if: ${{ secrets.CLOUDFLARE_API_TOKEN != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install wrangler
        run: npm install -g wrangler

      - name: Deploy Stripe worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: "848cf0b18d51e0170e0d1537aec3505a"
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
        working-directory: workers/stripe
        run: |
          if [ -n "$STRIPE_SECRET_KEY" ]; then
            echo "$STRIPE_SECRET_KEY" | wrangler secret put STRIPE_SECRET_KEY
          fi
          if [ -n "$STRIPE_WEBHOOK_SECRET" ]; then
            echo "$STRIPE_WEBHOOK_SECRET" | wrangler secret put STRIPE_WEBHOOK_SECRET
          fi
          wrangler deploy
